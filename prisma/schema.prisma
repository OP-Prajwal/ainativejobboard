generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Installation {
  id                String   @id @default(uuid()) @db.Uuid
  installationId    String   @unique @map("installation_id") @db.Uuid
  domain            String?  @db.VarChar(255)
  installationToken String?  @map("installation_token")
  status            String   @default("active") @db.VarChar(50)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  lastSeenAt        DateTime @default(now()) @map("last_seen_at") @db.Timestamptz(6)
  metadata          Json?    @default("{}")

  @@index([installationId])
  @@map("installations")
}

model Company {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  slug        String   @unique @db.VarChar(255)
  logo_url    String?
  website_url String?
  status      String   @default("unverified") @db.VarChar(50)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  jobs        Job[]

  @@map("companies")
}

model Job {
  id               String           @id @default(uuid()) @db.Uuid
  title            String           @db.VarChar(255)
  description      String
  companyId        String           @map("company_id") @db.Uuid
  slug             String           @unique @db.VarChar(500)
  rawRequirements  Json?            @map("raw_requirements")
  type             String           @default("Full-time") @db.VarChar(50)
  location         String           @default("Remote") @db.VarChar(100)
  salary           String?          @db.VarChar(100)
  category         String?          @db.VarChar(100)
  subcategory      String?          @db.VarChar(100)
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  experienceLevel  String?          @map("experience_level") @db.VarChar(50)
  salaryMax        Int?             @map("salary_max")
  salaryMin        Int?             @map("salary_min")
  status           String           @default("active") @db.VarChar(50)
  updatedAt        DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  applications     Application[]
  jobOutcomes      JobOutcome[]
  jobTasks         JobTask[]
  company          Company          @relation(fields: [companyId], references: [id])
  signalProfile    SignalProfile?
  assessmentScheduledAt DateTime?      @map("assessment_scheduled_at") @db.Timestamptz(6)
  assessmentConfig      Json?          @map("assessment_config")

  @@map("jobs")
}

model Application {
  id              String   @id @default(uuid()) @db.Uuid
  jobId           String   @map("job_id") @db.Uuid
  name            String   @db.VarChar(255)
  email           String   @db.VarChar(255)
  resumeUrl       String   @map("resume_url")
  linkedinUrl     String?  @map("linkedin_url")
  portfolioUrl    String?  @map("portfolio_url")
  githubId        String?  @map("github_id")
  leetcodeId      String?  @map("leetcode_id")
  codeforcesId    String?  @map("codeforces_id")
  coverLetter     String?  @map("cover_letter")
  status          String   @default("pending") @db.VarChar(50)
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  enrichmentData  Json?    @map("enrichment_data")
  job             Job      @relation(fields: [jobId], references: [id])
  taskAssignments TaskAssignment[]

  @@index([jobId])
  @@map("applications")
}

model JobOutcome {
  id                  String      @id @default(uuid()) @db.Uuid
  jobId               String      @map("job_id") @db.Uuid
  description         String      @map("outcome_description")
  successMetrics      Json?       @map("success_metrics")
  failureConditions   Json?       @map("failure_conditions")
  priorityLevel       Int         @default(1) @map("priority_level")
  job                 Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobTasks            JobTask[]

  @@map("job_outcomes")
}

model JobTask {
  id                   String           @id @default(uuid()) @db.Uuid
  jobId                String           @map("job_id") @db.Uuid
  outcomeId            String?          @map("outcome_id") @db.Uuid
  taskType             String           @map("task_type") @db.VarChar(50)
  description          String
  expectedArtifacts    Json?            @map("expected_artifacts")
  evaluationCriteria   Json?            @map("evaluation_criteria")
  difficultyLevel      Int              @default(1) @map("difficulty_level")
  estimatedTimeHours   Float?           @map("estimated_time_hours")
  taskInvariants       Json?            @map("task_invariants")
  starterCode          String?          @map("starter_code") @db.Text
  job                  Job              @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobOutcome           JobOutcome?      @relation(fields: [outcomeId], references: [id])
  taskAssignments      TaskAssignment[]

  @@map("job_tasks")
}

model SignalProfile {
  id                        String @id @default(uuid()) @db.Uuid
  jobId                     String @unique @map("job_id") @db.Uuid
  scopeControlWeight        Float  @map("scope_control_weight")
  ambiguityHandlingWeight   Float  @map("ambiguity_handling_weight")
  decisionQualityWeight     Float  @map("decision_quality_weight")
  stabilityWeight           Float  @map("stability_weight")
  learningRateWeight        Float  @map("learning_rate_weight")
  job                       Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@map("signal_profiles")
}

model TaskAssignment {
  id                     String    @id @default(uuid()) @db.Uuid
  applicationId          String    @map("application_id") @db.Uuid
  taskId                 String    @map("task_id") @db.Uuid
  
  // Lifecycle
  status                 String    @default("PENDING") @db.VarChar(50)
  scheduledAt            DateTime? @map("scheduled_at") @db.Timestamptz(6)
  startedAt              DateTime? @map("started_at") @db.Timestamptz(6)
  submittedAt            DateTime? @map("submitted_at") @db.Timestamptz(6)
  timeLimitMinutes       Int       @default(60) @map("time_limit_minutes")
  timeTakenSeconds       Int?      @map("time_taken_seconds")
  
  // Transparency Fields (Candidate-provided)
  initialPrompt          String?   @map("initial_prompt") @db.Text
  aiDraft                String?   @map("ai_draft") @db.Text
  finalSubmission        String?   @map("final_submission") @db.Text
  refinementExplanation  String?   @map("refinement_explanation") @db.Text
  unchangedExplanation   String?   @map("unchanged_explanation") @db.Text
  
  // AI Evaluation Fields
  aiScore                Int?      @map("ai_score")
  confidence             Float?
  uncertaintyReasons     Json?     @map("uncertainty_reasons")
  diffSummary            Json?     @map("diff_summary")
  aiFeedback             String?   @map("ai_feedback") @db.Text
  strongestPositive      String?   @map("strongest_positive") @db.Text
  strongestNegative      String?   @map("strongest_negative") @db.Text
  whatWouldChangeScore   String?   @map("what_would_change_score") @db.Text
  evaluationVersion      Int       @default(1) @map("evaluation_version")
  
  // Human Override Fields
  humanScore             Int?      @map("human_score")
  humanOverrideReason    String?   @map("human_override_reason") @db.Text
  humanReviewedAt        DateTime? @map("human_reviewed_at") @db.Timestamptz(6)
  reviewedBy             String?   @map("reviewed_by") @db.VarChar(255)
  requiresHumanReview    Boolean   @default(false) @map("requires_human_review")
  
  // Relations
  application            Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  task                   JobTask     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@unique([applicationId, taskId])
  @@index([applicationId])
  @@index([status])
  @@map("task_assignments")
}
